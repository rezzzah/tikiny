<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>Yuki Add Design</title>
    <!-- โหลด Tailwind CSS จาก CDN เพื่อใช้ในการจัดสไตล์ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* กำหนดฟอนต์ Inter ทั่วทั้งแอปพลิเคชัน */
      body {
        font-family: "Inter", sans-serif;
      }

    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="root" class="bg-white p-8 rounded-lg shadow-lg"></div>

    <!-- โหลด React, ReactDOM และ Babel -->
    <!-- React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <!-- ReactDOM สำหรับการเรนเดอร์ React Component เข้าสู่ DOM -->
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone สำหรับการแปลง JSX ในเบราว์เซอร์ (เหมาะสำหรับการพัฒนาและตัวอย่างเล็กๆ) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>


    <!-- Module Section -->
    <script type="text/babel">

      /**
       * Proto Component
       * เป็นตัวอย่าง Functional Component ที่ใช้ React.forwardRef
       * ในที่นี้ props 'a', 'b', 'c' และ ref ไม่ได้ถูกใช้งาน แต่แสดงวิธีการรับ props และ ref
       *
       * @param {object} props - Properties ที่ส่งมายัง Component
       * @param {any} props.a - ตัวอย่าง prop A (ไม่ได้ใช้ในตัวอย่างนี้)
       * @param {any} props.b - ตัวอย่าง prop B (ไม่ได้ใช้ในตัวอย่างนี้)
       * @param {any} props.c - ตัวอย่าง prop C (ไม่ได้ใช้ในตัวอย่างนี้)
       * @param {React.Ref} ref - Ref ที่ส่งมา (ไม่ได้ใช้ในตัวอย่างนี้)
       */
      const Proto = React.forwardRef(({ a, b, c }, ref) => {
        // useImperativeHandle ใช้สำหรับกำหนดค่า Ref ที่เป็น Object ซึ่ง Parent Component สามารถเรียกใช้ได้
        // ในที่นี้กำหนดให้มีฟังก์ชัน fn1 และ fn2 แต่ยังไม่ได้มีการใช้งานจริง
        React.useImperativeHandle(ref, () => ({
          fn1() {
            console.log("fn1 called from Proto component.");
          },
          fn2() {
            console.log("fn2 called from Proto component.");
          }
        }));
  
        return (
          <div className="text-2xl font-bold text-blue-600">
            Hello React from Google Apps Script!
          </div>
        );
      });
  

      const YukiAddComponent = React.forwardRef(({ a, b, c }, ref) => {
        // useImperativeHandle ใช้สำหรับกำหนดค่า Ref ที่เป็น Object ซึ่ง Parent Component สามารถเรียกใช้ได้
        // ในที่นี้กำหนดให้มีฟังก์ชัน fn1 และ fn2 แต่ยังไม่ได้มีการใช้งานจริง
        React.useImperativeHandle(ref, () => ({
          fn1() {
            console.log("fn1 called from Proto component.");
          },
          fn2() {
            console.log("fn2 called from Proto component.");
          }
        }));
  
        // State for image input and list
        const [imageUrl, setImageUrl] = React.useState("");
        const [images, setImages] = React.useState([]);
        // State for product image input and list
        const [productImageUrl, setProductImageUrl] = React.useState("");
        const [productImages, setProductImages] = React.useState([]);
        // Add state for pattern name
        const [patternName, setPatternName] = React.useState("");
        // Add state for pattern ID and product URL
        const [patternId, setPatternId] = React.useState("");
        const [productUrl, setProductUrl] = React.useState("");
        // Add state for price
        const [price, setPrice] = React.useState("0");
        // Add state for product code
        const [productCode, setProductCode] = React.useState("");
        // Add state for product name (independent from pattern name)
        const [productName, setProductName] = React.useState("");
        // เพิ่ม state สำหรับเก็บ JSON ที่ submit แล้ว
        const [submittedJson, setSubmittedJson] = React.useState("");
        // เพิ่ม state สำหรับเก็บผลลัพธ์การส่งข้อมูล
        const [submitResult, setSubmitResult] = React.useState("");
        const [stockDesigns, setStockDesigns] = React.useState([]);
        // เพิ่ม state สำหรับควบคุมการ disable input/button ขณะส่งข้อมูล
        const [isSubmitting, setIsSubmitting] = React.useState(false);
        // เพิ่ม state สำหรับ loading
        const [isLoadingStock, setIsLoadingStock] = React.useState(true);
        // Add state for colors
        const [colors, setColors] = React.useState([]);
        const [colorInput, setColorInput] = React.useState("");
        // เพิ่ม state groupid
        const [groupid, setGroupid] = React.useState("");
  
        const handleAddImage = () => {
          if (imageUrl.trim() !== "") {
            setImages([...images, imageUrl.trim()]);
            setImageUrl("");
          }
        };
        const handleAddProductImage = () => {
          if (productImageUrl.trim() !== "") {
            setProductImages([...productImages, productImageUrl.trim()]);
            setProductImageUrl("");
          }
        };
  
        // เพิ่มฟังก์ชัน clearAll สำหรับรีเซ็ตค่าทุก input
        const clearAll = () => {
          setPatternId("");
          setPatternName("");
          setProductCode("");
          setProductName("");
          setPrice("0");
          setImages([]);
          setProductImages([]);
          setProductUrl("");
          setSubmittedJson("");
          setSubmitResult("");
          setColors([]);
          setColorInput("");
          setGroupid("");
        };
  
        // โหลด stock_designs ตอน mount
        React.useEffect(() => {
          setIsLoadingStock(true);
          fetch("https://script.google.com/macros/s/AKfycbwB9tUS7pHLR3GYOaik6pYj1_RWAPa4EEwplaV7F9hcv2oHRY0y0DkgdIdo-NgjPf3C/exec?action=getYukiDesign")
            .then(res => res.json())
            .then(data => setStockDesigns(data))
            .catch(() => setStockDesigns([]))
            .finally(() => setIsLoadingStock(false));
        }, []);
  
        // ฟังก์ชัน normalize สำหรับ patternId
        const normalizePatternId = id => String(id).replaceAll('"', '').trim();
  
        // เมื่อ patternId เปลี่ยน ให้เช็คและ popup ถ้าตรงกับข้อมูล
        React.useEffect(() => {
          if (!patternId) return;
          const matches = stockDesigns.filter(item => normalizePatternId(item.patternId) === normalizePatternId(patternId));
        }, [patternId, stockDesigns]);
  
        return (
          <div className="relative w-[500px] text-2xl flex flex-col items-center justify-center">
            {/* Loading overlay เฉพาะฟอร์ม */}
            {isSubmitting && (
              <div className="absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg p-6 flex items-center shadow-lg">
                  <svg className="animate-spin h-6 w-6 mr-3 text-blue-600" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                  </svg>
                  <span className="text-lg font-semibold text-blue-700">กำลังส่งข้อมูล...</span>
                </div>
              </div>
            )}
            <div className="text-center">
              <h1 className="text-3xl font-bold text-gray-800 mb-4">Yuki Add a Design</h1>
            </div>
            <div className="flex items-center my-6 w-full">
              <div className="flex-grow border-t border-slate-300"></div>
              <span className="mx-4 text-slate-500 font-semibold text-sm">Factory Data</span>
              <div className="flex-grow border-t border-slate-300"></div>
            </div>
            <div className="w-full max-w-md space-y-4">
              <div className="flex flex-col">
                <label className="text-sm font-medium text-gray-700 mb-1">Pattern ID:</label>
                <input 
                  type="number" 
                  value={patternId}
                  onChange={e => setPatternId(e.target.value)}
                  className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Enter pattern ID"
                  disabled={isSubmitting}
                />
              </div>
              {patternId && (
                (() => {
                  const filteredStockDesigns = stockDesigns.filter(item => normalizePatternId(item.patternId) === normalizePatternId(patternId));
                  return (
                    <div className="mb-4 p-3 bg-slate-50 border border-slate-200 rounded-lg text-base">
                      <div className="font-bold text-blue-700 mb-2">รายการ Pattern ID ที่ตรงกับที่กรอก</div>
                      <div className="max-h-40 overflow-y-auto">
                        {isLoadingStock ? (
                          <div className="flex items-center justify-center py-6">
                            <svg className="animate-spin h-6 w-6 text-blue-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
                            <span>Loading...</span>
                          </div>
                        ) : filteredStockDesigns.length > 0 ? (
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="bg-slate-100">
                                <th className="text-left px-2 py-1">Pattern ID</th>
                                <th className="text-left px-2 py-1">Pattern Name</th>
                                <th className="text-left px-2 py-1">Product Code</th>
                              </tr>
                            </thead>
                            <tbody>
                              {filteredStockDesigns.map((item, idx) => (
                                <tr key={idx} className="odd:bg-white even:bg-slate-50">
                                  <td className="px-2 py-1 text-blue-900">{item.patternId}</td>
                                  <td
                                    className="px-2 py-1 text-gray-800 cursor-pointer hover:underline hover:text-blue-600"
                                    title="คลิกเพื่อกรอกลงในช่อง Pattern Name"
                                    onClick={() => setPatternName(item.patternName.replaceAll('"', '').trim())}
                                  >
                                    {item.patternName}
                                  </td>
                                  <td className="px-2 py-1 text-gray-700">{item.productCode || '-'}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        ) : (
                          <div className="text-gray-500 text-sm py-2">ไม่พบ Pattern ID ที่ตรงกัน</div>
                        )}
                      </div>
                    </div>
                  );
                })()
              )}
              <div className="flex flex-col">
                <label className="text-sm font-medium text-gray-700 mb-1">Pattern Name:</label>
                <input 
                  type="text" 
                  value={patternName}
                  onChange={e => setPatternName(e.target.value)}
                  className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Enter pattern name"
                  disabled={isSubmitting}
                />
              </div>
              
              <div className="flex flex-col">
                <label className="text-sm font-medium text-gray-700 mb-1">Price:</label>
                <input
                  type="number"
                  value={price}
                  onChange={e => setPrice(e.target.value)}
                  min="0"
                  step="5"
                  className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Enter price"
                  disabled={isSubmitting}
                />
              </div>
              
              <div className="flex flex-col">
                <label className="text-sm font-medium text-gray-700 mb-1">Images:</label>
                <div className="flex space-x-2 mb-2">
                  <input
                    type="text"
                    value={imageUrl}
                    onChange={e => setImageUrl(e.target.value)}
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Enter image URL"
                    disabled={isSubmitting}
                  />
                  <button
                    type="button"
                    onClick={handleAddImage}
                    className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                    disabled={isSubmitting}
                  >
                    Add
                  </button>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  {images.map((url, idx) => (
                    <div key={idx} className="flex flex-col items-center relative border-4 border-slate-400 rounded-2xl p-3 bg-white">
                      <button
                        type="button"
                        onClick={() => setImages(images.filter((_, i) => i !== idx))}
                        className="absolute top-2 right-2 bg-slate-500 text-slate-100 rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-slate-700 shadow-md"
                        title="Remove image"
                      >
                        <span className="text-lg font-bold">×</span>
                      </button>
                      <div className="w-28 h-28 rounded-lg overflow-hidden flex items-center justify-center bg-white mb-1">
                        <img src={url} alt={`img-${idx}`} className="w-full h-full object-cover" />
                      </div>
                      <span className="text-xs text-gray-600 break-all">{url}</span>
                    </div>
                  ))}
                </div>
              </div>
              
              <div className="flex items-center my-6">
                <div className="flex-grow border-t border-slate-300"></div>
                <span className="mx-4 text-slate-500 font-semibold text-sm">Product Data</span>
                <div className="flex-grow border-t border-slate-300"></div>
              </div>
              
              <div className="flex flex-col mb-2">
                <label className="text-sm font-medium text-gray-700 mb-1">Product Name:</label>
                <input
                  type="text"
                  value={productName}
                  onChange={e => setProductName(e.target.value)}
                  className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Enter product name"
                  disabled={isSubmitting}
                />
              </div>
          
              
              <div className="flex flex-col">
                <label className="text-sm font-medium text-gray-700 mb-1">Product Code:</label>
                <input
                  type="text"
                  value={productCode}
                  onChange={e => setProductCode(e.target.value)}
                  className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Enter product code"
                  disabled={isSubmitting}
                />
              </div>
              
              <div className="flex flex-col">
                <label className="text-sm font-medium text-gray-700 mb-1">Product Images:</label>
                <div className="flex space-x-2 mb-2">
                  <input
                    type="text"
                    value={productImageUrl}
                    onChange={e => setProductImageUrl(e.target.value)}
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Enter product image URL"
                    disabled={isSubmitting}
                  />
                  <button
                    type="button"
                    onClick={handleAddProductImage}
                    className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                    disabled={isSubmitting}
                  >
                    Add
                  </button>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  {productImages.map((url, idx) => (
                    <div key={idx} className="flex flex-col items-center relative border-4 border-slate-400 rounded-2xl p-3 bg-white">
                      <button
                        type="button"
                        onClick={() => setProductImages(productImages.filter((_, i) => i !== idx))}
                        className="absolute top-2 right-2 bg-slate-500 text-slate-100 rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-slate-700 shadow-md"
                        title="Remove product image"
                      >
                        <span className="text-lg font-bold">×</span>
                      </button>
                      <div className="w-28 h-28 rounded-lg overflow-hidden flex items-center justify-center bg-white mb-1">
                        <img src={url} alt={`product-img-${idx}`} className="w-full h-full object-cover" />
                      </div>
                      <span className="text-xs text-gray-600 break-all">{url}</span>
                    </div>
                  ))}
                </div>
              </div>
              
              <div className="flex flex-col">
                <label className="text-sm font-medium text-gray-700 mb-1">Colors:</label>
                <div className="flex space-x-2 mb-2">
                  <input
                    type="text"
                    value={colorInput}
                    onChange={e => setColorInput(e.target.value)}
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="เช่น S1-Black"
                    disabled={isSubmitting}
                  />
                  <button
                    type="button"
                    onClick={() => {
                      if (colorInput.trim() !== "") {
                        setColors([...colors, colorInput.trim()]);
                        setColorInput("");
                      }
                    }}
                    className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                    disabled={isSubmitting}
                  >
                    Add
                  </button>
                </div>
                <div className="flex flex-col gap-2">
                  {(Array.isArray(colors) ? colors : []).map((color, idx) => (
                    <div key={idx} className="flex items-center relative border border-slate-300 rounded-lg p-2 bg-white">
                      <div className="flex flex-col mr-2">
                        <button
                          type="button"
                          onClick={() => {
                            if (idx > 0) {
                              const newColors = [...colors];
                              [newColors[idx - 1], newColors[idx]] = [newColors[idx], newColors[idx - 1]];
                              setColors(newColors);
                            }
                          }}
                          className="text-xs text-gray-500 hover:text-blue-600 disabled:opacity-30"
                          disabled={idx === 0}
                          title="Move up"
                        >↑</button>
                        <button
                          type="button"
                          onClick={() => {
                            if (idx < colors.length - 1) {
                              const newColors = [...colors];
                              [newColors[idx + 1], newColors[idx]] = [newColors[idx], newColors[idx + 1]];
                              setColors(newColors);
                            }
                          }}
                          className="text-xs text-gray-500 hover:text-blue-600 disabled:opacity-30"
                          disabled={idx === colors.length - 1}
                          title="Move down"
                        >↓</button>
                      </div>
                      <button
                        type="button"
                        onClick={() => setColors(colors.filter((_, i) => i !== idx))}
                        className="absolute top-1 right-1 bg-slate-500 text-slate-100 rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-slate-700 shadow-md"
                        title="Remove color"
                      >
                        <span className="text-base font-bold">×</span>
                      </button>
                      <span className="min-w-[160px] inline-block">{color}</span>
                    </div>
                  ))}
                </div>
              </div>
              
              <div className="flex flex-col">
                <label className="text-sm font-medium text-gray-700 mb-1">Product URL:</label>
                <div className="flex space-x-2">
                  <input 
                    type="text" 
                    value={productUrl}
                    onChange={e => setProductUrl(e.target.value)}
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Enter product URL"
                    disabled={isSubmitting}
                  />
                  <button
                    type="button"
                    className="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm"
                    disabled={!productUrl || isSubmitting}
                    onClick={() => {
                      // ดึงรหัสสินค้าจาก URL เช่น https://item.rakuten.co.jp/isle-domore/bbt1844/
                      const match = productUrl.match(/\/([^\/]+)\/?$/);
                      if (match && match[1]) {
                        setProductName(match[1]);
                        setProductCode(match[1]);
                      }
                    }}
                    title="Auto fill Product Name & Code"
                  >
                    Auto Fill
                  </button>
                </div>
              </div>
              <div className="flex flex-col">
                <label className="text-sm font-medium text-gray-700 mb-1">Group ID:</label>
                <input
                  type="text"
                  value={groupid}
                  onChange={e => setGroupid(e.target.value)}
                  className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="กรอก Group ID"
                  disabled={isSubmitting}
                />
              </div>
            </div>
            <div className="flex justify-center mt-8 w-full">
              <button
                type="button"
                className="px-8 py-3 bg-blue-600 text-white rounded-lg text-lg font-semibold shadow hover:bg-blue-700 transition"
                onClick={async () => {
                  setIsSubmitting(true);
                  const formData = {
                    action: 'addNewYukiDesign',
                    patternId,
                    patternName,
                    productCode,
                    productName,
                    price: price ? parseFloat(price) : 0,
                    images: encodeURIComponent(JSON.stringify(images)),
                    productImages: encodeURIComponent(JSON.stringify(productImages)),
                    productUrl,
                    colors: encodeURIComponent(JSON.stringify(colors)),
                    groupid,
                  };
                  setSubmittedJson(JSON.stringify(formData, null, 2));
                  setSubmitResult("");
                  try {
                    const params = new URLSearchParams(formData).toString();
                    const response = await fetch('https://script.google.com/macros/s/AKfycbwB9tUS7pHLR3GYOaik6pYj1_RWAPa4EEwplaV7F9hcv2oHRY0y0DkgdIdo-NgjPf3C/exec?' + params);
                    const result = await response.json();
                    setSubmitResult("ส่งข้อมูลสำเร็จ: " + JSON.stringify(result));
                  } catch (err) {
                    setSubmitResult("เกิดข้อผิดพลาดในการส่งข้อมูล: " + err.message);
                  } finally {
                    setIsSubmitting(false);
                  }
                }}
                disabled={isSubmitting}
              >
                Submit
              </button>
            </div>
            <div className="flex justify-center mt-2 w-full">
              <button
                type="button"
                className="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg text-base font-medium shadow hover:bg-gray-400 transition"
                onClick={clearAll}
                disabled={isSubmitting}
              >
                ล้างข้อมูล
              </button>
            </div>
            {submittedJson && (
              <div className="mt-6 w-full bg-gray-100 rounded p-4 text-sm text-gray-800 whitespace-pre-wrap border border-gray-300">
                <div className="mb-2 font-bold text-blue-700">ข้อมูลที่ส่ง (JSON):</div>
                <pre>{submittedJson}</pre>
              </div>
            )}
            {submitResult && (
              <div className="mt-4 w-full bg-yellow-50 rounded p-3 text-sm text-yellow-800 border border-yellow-300">
                {submitResult}
              </div>
            )}
          </div>
        );
      });

      // เพิ่ม YukiEditComponent
      const YukiEditComponent = () => {
        // State สำหรับค้นหาและเลือกข้อมูล
        const [patternId, setPatternId] = React.useState("");
        const [stockDesigns, setStockDesigns] = React.useState([]);
        const [selectedRow, setSelectedRow] = React.useState(null);
        // State สำหรับฟอร์มแก้ไข
        const [editData, setEditData] = React.useState({
          patternId: '',
          patternName: '',
          price: '',
          images: [],
          productName: '',
          productCode: '',
          productImages: [],
          productUrl: '',
          _imageInput: '',
          _productImageInput: '',
          colors: [],
          _colorInput: '',
          groupid: '',
        });
        const [editEnabled, setEditEnabled] = React.useState(false);
        const [submitResult, setSubmitResult] = React.useState("");
        // เพิ่ม state สำหรับควบคุมการ disable input/button ขณะส่งข้อมูล
        const [isSubmitting, setIsSubmitting] = React.useState(false);
        // เพิ่ม state สำหรับ loading
        const [isLoadingStock, setIsLoadingStock] = React.useState(true);
        const [showAll, setShowAll] = React.useState(false);

        // โหลด stock_designs ตอน mount
        React.useEffect(() => {
          setIsLoadingStock(true);
          fetch("https://script.google.com/macros/s/AKfycbwB9tUS7pHLR3GYOaik6pYj1_RWAPa4EEwplaV7F9hcv2oHRY0y0DkgdIdo-NgjPf3C/exec?action=getYukiDesign")
            .then(res => res.json())
            .then(data => setStockDesigns(data))
            .catch(() => setStockDesigns([]))
            .finally(() => setIsLoadingStock(false));
        }, []);

        // ฟังก์ชัน normalize สำหรับ patternId
        const normalizePatternId = id => String(id).replaceAll('"', '').trim();

        // Filter เฉพาะรายการที่ patternId ตรงกับที่กรอก
        const searchText = normalizePatternId(patternId).toLowerCase();
        const filteredRows = searchText
          ? stockDesigns.filter(item => {
              const pid = normalizePatternId(item.patternId).toLowerCase();
              const pcode = normalizePatternId(item.productCode).toLowerCase();
              const pname = (item.patternName || '').toLowerCase();
              return pid.includes(searchText) || pcode.includes(searchText) || pname.includes(searchText);
            })
          : [];

        // เมื่อเลือกแถว ให้ setEditData เป็นข้อมูลแถวนั้น (parse images/productImages ถ้าเป็น string)
        const handleSelectRow = (row) => {
          // parse images/productImages ถ้าเป็น string
          let images = row.images;
          let productImages = row.productImages;
          let colors = row.colors;
          if (!Array.isArray(colors)) {
            try {
              if (typeof colors === 'string') {
                colors = JSON.parse(colors);
              }
              if (!Array.isArray(colors)) colors = [];
            } catch { colors = []; }
          }
          try {
            if (typeof images === 'string') images = JSON.parse(images);
          } catch {}
          try {
            if (typeof productImages === 'string') productImages = JSON.parse(productImages);
          } catch {}
          // ลบ " ออกจากทุกฟิลด์ string
          const cleanRow = Object.fromEntries(
            Object.entries({ ...row, images, productImages, colors }).map(([k, v]) =>
              [k, typeof v === 'string' ? v.replaceAll('"', '').trim() : v]
            )
          );
          // แก้ไข price ให้เป็น string เสมอ และลบ " ออก
          if (cleanRow.price !== undefined && cleanRow.price !== null) {
            cleanRow.price = String(cleanRow.price).replaceAll('"', '').trim();
          } else {
            cleanRow.price = '';
          }
          setSelectedRow(row);
          setEditData(cleanRow);
          setEditEnabled(true);
          setSubmitResult("");
        };

        // handle input change ในฟอร์มแก้ไข
        const handleEditChange = (field, value) => {
          setEditData(prev => ({ ...prev, [field]: value }));
        };

        // handle save (ตัวอย่าง: แค่โชว์ JSON ที่จะส่ง)
        const handleSave = async () => {
          setIsSubmitting(true);
          try {
            const formData = {
              action: 'updateYukiDesign',
              ...editData,
              images: encodeURIComponent(JSON.stringify(editData.images || [])),
              productImages: encodeURIComponent(JSON.stringify(editData.productImages || [])),
              colors: encodeURIComponent(JSON.stringify(editData.colors || [])),
              groupid: editData.groupid,
            };
            const params = new URLSearchParams(formData).toString();
            const response = await fetch('https://script.google.com/macros/s/AKfycbwB9tUS7pHLR3GYOaik6pYj1_RWAPa4EEwplaV7F9hcv2oHRY0y0DkgdIdo-NgjPf3C/exec?' + params);
            const result = await response.json();
            setSubmitResult("บันทึกข้อมูลสำเร็จ: " + JSON.stringify(result));
          } catch (err) {
            setSubmitResult("เกิดข้อผิดพลาดในการบันทึกข้อมูล: " + err.message);
          } finally {
            setIsSubmitting(false);
          }
        };

        // handle cancel
        const handleCancel = () => {
          setSelectedRow(null);
          setEditData({
            patternId: '',
            patternName: '',
            price: '',
            images: [],
            productName: '',
            productCode: '',
            productImages: [],
            productUrl: '',
            _imageInput: '',
            _productImageInput: '',
            colors: [],
            _colorInput: '',
            groupid: '',
          });
          setEditEnabled(false);
          setSubmitResult("");
        };

        return (
          <div className="w-[500px] text-2xl flex flex-col items-center justify-center">
            {/* Loading overlay */}
            {isSubmitting && (
              <div className="fixed inset-0 bg-black bg-opacity-20 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg p-6 flex items-center shadow-lg">
                  <svg className="animate-spin h-6 w-6 mr-3 text-blue-600" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                  </svg>
                  <span className="text-lg font-semibold text-blue-700">กำลังส่งข้อมูล...</span>
                </div>
              </div>
            )}
            <div className="text-center">
              <h1 className="text-3xl font-bold text-gray-800 mb-4">Yuki Edit a Design</h1>
            </div>
            <div className="w-full max-w-md space-y-4">
              <div className="flex flex-col">
                <label className="text-sm font-medium text-gray-700 mb-1">ค้นหา Pattern ID, Product Code หรือ Pattern Name:</label>
                <div className="flex">
                  <input
                    type="text"
                    value={patternId}
                    onChange={e => {
                      setPatternId(e.target.value);
                      // setShowAll(false); // ลบ logic นี้ออกด้วย
                    }}
                    className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="กรอก Pattern ID, Product Code หรือ Pattern Name ที่ต้องการแก้ไข"
                  />
                </div>
              </div>
              {patternId && (
                <div className="mb-4 p-3 bg-slate-50 border border-slate-200 rounded-lg text-base">
                  <div className="font-bold text-blue-700 mb-2">รายการ Pattern ID ที่ตรงกับที่กรอก</div>
                  <div className="max-h-40 overflow-y-auto">
                    {isLoadingStock ? (
                      <div className="flex items-center justify-center py-6">
                        <svg className="animate-spin h-6 w-6 text-blue-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
                        <span>Loading...</span>
                      </div>
                    ) : filteredRows.length > 0 ? (
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="bg-slate-100">
                            <th className="text-left px-2 py-1">Pattern ID</th>
                            <th className="text-left px-2 py-1">Pattern Name</th>
                            <th className="text-left px-2 py-1">Product Code</th>
                          </tr>
                        </thead>
                        <tbody>
                          {filteredRows.map((item, idx) => (
                            <tr
                              key={idx}
                              className="odd:bg-white even:bg-slate-50 cursor-pointer hover:bg-blue-50"
                              onClick={() => handleSelectRow(item)}
                            >
                              <td className="px-2 py-1 text-blue-900">{item.patternId}</td>
                              <td className="px-2 py-1 text-gray-800">{item.patternName}</td>
                              <td className="px-2 py-1 text-gray-700">{item.productCode || '-'}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    ) : (
                      <div className="text-gray-500 text-sm py-2">ไม่พบ Pattern ID ที่ตรงกัน</div>
                    )}
                  </div>
                </div>
              )}
              {/* ฟอร์มแก้ไขข้อมูล */}
              {editData && (
                <div className="w-full bg-white border border-slate-300 rounded-lg p-4 mt-4">
                  <div className="text-lg font-bold mb-2 text-blue-700">แก้ไขข้อมูล</div>
                  <div className="space-y-2">
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-gray-700 mb-1">Pattern ID:</label>
                      <input
                        type="text"
                        value={editData.patternId}
                        disabled
                        className="px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-500 focus:outline-none"
                      />
                    </div>
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-gray-700 mb-1">Pattern Name:</label>
                      <input
                        type="text"
                        value={editData.patternName}
                        onChange={e => handleEditChange('patternName', e.target.value)}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        disabled={!editEnabled || isSubmitting}
                      />
                    </div>
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-gray-700 mb-1">Price:</label>
                      <input
                        type="number"
                        value={editData.price || ''}
                        onChange={e => handleEditChange('price', e.target.value)}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        disabled={!editEnabled || isSubmitting}
                      />
                    </div>
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-gray-700 mb-1">Images:</label>
                      <div className="flex space-x-2 mb-2">
                        <input
                          type="text"
                          value={editData._imageInput || ''}
                          onChange={e => setEditData(prev => ({ ...prev, _imageInput: e.target.value }))}
                          className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Enter image URL"
                          disabled={!editEnabled || isSubmitting}
                        />
                        <button
                          type="button"
                          onClick={() => {
                            if (editData._imageInput && editData._imageInput.trim() !== '') {
                              const imgs = Array.isArray(editData.images) ? editData.images : [];
                              setEditData(prev => ({ ...prev, images: [...imgs, editData._imageInput.trim()], _imageInput: '' }));
                            }
                          }}
                          className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                          disabled={!editEnabled || isSubmitting}
                        >
                          Add
                        </button>
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                        {(Array.isArray(editData.images) ? editData.images : []).map((url, idx) => (
                          <div key={idx} className="flex flex-col items-center relative border-4 border-slate-400 rounded-2xl p-3 bg-white">
                            <button
                              type="button"
                              onClick={() => setEditData(prev => ({ ...prev, images: prev.images.filter((_, i) => i !== idx) }))}
                              className="absolute top-2 right-2 bg-slate-500 text-slate-100 rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-slate-700 shadow-md"
                              title="Remove image"
                              disabled={!editEnabled || isSubmitting}
                            >
                              <span className="text-lg font-bold">×</span>
                            </button>
                            <div className="w-28 h-28 rounded-lg overflow-hidden flex items-center justify-center bg-white mb-1">
                              <img src={url} alt={`img-${idx}`} className="w-full h-full object-cover" />
                            </div>
                            <span className="text-xs text-gray-600 break-all">{url}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="flex items-center my-6">
                      <div className="flex-grow border-t border-slate-300"></div>
                      <span className="mx-4 text-slate-500 font-semibold text-sm">Product Data</span>
                      <div className="flex-grow border-t border-slate-300"></div>
                    </div>
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-gray-700 mb-1">Product Name:</label>
                      <input
                        type="text"
                        value={editData.productName || ''}
                        onChange={e => handleEditChange('productName', e.target.value)}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        disabled={!editEnabled || isSubmitting}
                      />
                    </div>
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-gray-700 mb-1">Product Code:</label>
                      <input
                        type="text"
                        value={editData.productCode || ''}
                        onChange={e => handleEditChange('productCode', e.target.value)}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        disabled={!editEnabled || isSubmitting}
                      />
                    </div>
                    {/* Product Images (array) */}
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-gray-700 mb-1">Product Images:</label>
                      <div className="flex space-x-2 mb-2">
                        <input
                          type="text"
                          value={editData._productImageInput || ''}
                          onChange={e => setEditData(prev => ({ ...prev, _productImageInput: e.target.value }))}
                          className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Enter product image URL"
                          disabled={!editEnabled || isSubmitting}
                        />
                        <button
                          type="button"
                          onClick={() => {
                            if (editData._productImageInput && editData._productImageInput.trim() !== '') {
                              const imgs = Array.isArray(editData.productImages) ? editData.productImages : [];
                              setEditData(prev => ({ ...prev, productImages: [...imgs, editData._productImageInput.trim()], _productImageInput: '' }));
                            }
                          }}
                          className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                          disabled={!editEnabled || isSubmitting}
                        >
                          Add
                        </button>
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                        {(Array.isArray(editData.productImages) ? editData.productImages : []).map((url, idx) => (
                          <div key={idx} className="flex flex-col items-center relative border-4 border-slate-400 rounded-2xl p-3 bg-white">
                            <button
                              type="button"
                              onClick={() => setEditData(prev => ({ ...prev, productImages: prev.productImages.filter((_, i) => i !== idx) }))}
                              className="absolute top-2 right-2 bg-slate-500 text-slate-100 rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-slate-700 shadow-md"
                              title="Remove product image"
                              disabled={!editEnabled || isSubmitting}
                            >
                              <span className="text-lg font-bold">×</span>
                            </button>
                            <div className="w-28 h-28 rounded-lg overflow-hidden flex items-center justify-center bg-white mb-1">
                              <img src={url} alt={`product-img-${idx}`} className="w-full h-full object-cover" />
                            </div>
                            <span className="text-xs text-gray-600 break-all">{url}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-gray-700 mb-1">Colors:</label>
                      <div className="flex space-x-2 mb-2">
                        <input
                          type="text"
                          value={editData._colorInput || ''}
                          onChange={e => setEditData(prev => ({ ...prev, _colorInput: e.target.value }))}
                          className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="เช่น S1-Black"
                          disabled={!editEnabled || isSubmitting}
                        />
                        <button
                          type="button"
                          onClick={() => {
                            if (editData._colorInput && editData._colorInput.trim() !== '') {
                              const cols = Array.isArray(editData.colors) ? editData.colors : [];
                              setEditData(prev => ({ ...prev, colors: [...cols, editData._colorInput.trim()], _colorInput: '' }));
                            }
                          }}
                          className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                          disabled={!editEnabled || isSubmitting}
                        >
                          Add
                        </button>
                      </div>
                      <div className="flex flex-col gap-2">
                        {(Array.isArray(editData.colors) ? editData.colors : []).map((color, idx) => (
                          <div key={idx} className="flex items-center relative border border-slate-300 rounded-lg p-2 bg-white">
                            <div className="flex flex-col mr-2">
                              <button
                                type="button"
                                onClick={() => {
                                  if (idx > 0) {
                                    const newColors = [...editData.colors];
                                    [newColors[idx - 1], newColors[idx]] = [newColors[idx], newColors[idx - 1]];
                                    setEditData(prev => ({ ...prev, colors: newColors }));
                                  }
                                }}
                                className="text-xs text-gray-500 hover:text-blue-600 disabled:opacity-30"
                                disabled={idx === 0 || !editEnabled || isSubmitting}
                                title="Move up"
                              >↑</button>
                              <button
                                type="button"
                                onClick={() => {
                                  if (idx < editData.colors.length - 1) {
                                    const newColors = [...editData.colors];
                                    [newColors[idx + 1], newColors[idx]] = [newColors[idx], newColors[idx + 1]];
                                    setEditData(prev => ({ ...prev, colors: newColors }));
                                  }
                                }}
                                className="text-xs text-gray-500 hover:text-blue-600 disabled:opacity-30"
                                disabled={idx === editData.colors.length - 1 || !editEnabled || isSubmitting}
                                title="Move down"
                              >↓</button>
                            </div>
                            <button
                              type="button"
                              onClick={() => setEditData(prev => ({ ...prev, colors: prev.colors.filter((_, i) => i !== idx) }))}
                              className="absolute top-1 right-1 bg-slate-500 text-slate-100 rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-slate-700 shadow-md"
                              title="Remove color"
                              disabled={!editEnabled || isSubmitting}
                            >
                              <span className="text-base font-bold">×</span>
                            </button>
                            <span className="min-w-[160px] inline-block">{color}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-gray-700 mb-1">Product URL:</label>
                      <input
                        type="text"
                        value={editData.productUrl || ''}
                        onChange={e => handleEditChange('productUrl', e.target.value)}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        disabled={!editEnabled || isSubmitting}
                      />
                    </div>
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-gray-700 mb-1">Group ID:</label>
                      <input
                        type="text"
                        value={editData.groupid || ''}
                        onChange={e => handleEditChange('groupid', e.target.value)}
                        className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        disabled={!editEnabled || isSubmitting}
                        placeholder="กรอก Group ID"
                      />
                    </div>
                  </div>
                  <div className="flex space-x-4 mt-4">
                    <button
                      className="px-6 py-2 bg-blue-600 text-white rounded-lg text-base font-medium shadow hover:bg-blue-700 transition"
                      onClick={handleSave}
                      disabled={!editEnabled || isSubmitting}
                    >
                      Save
                    </button>
                    <button
                      className="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg text-base font-medium shadow hover:bg-gray-400 transition"
                      onClick={handleCancel}
                      disabled={!editEnabled || isSubmitting}
                    >
                      Cancel
                    </button>
                  </div>
                  {submitResult && (
                    <div className="mt-4 w-full bg-yellow-50 rounded p-3 text-sm text-yellow-800 border border-yellow-300">
                      {submitResult}
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        );
      };

      // เพิ่ม YukiShowAllComponent
      const YukiShowAllComponent = () => {
        const [data, setData] = React.useState([]);
        const [isLoading, setIsLoading] = React.useState(true);
        const [error, setError] = React.useState("");
        const [hoverImg, setHoverImg] = React.useState(null); // {url, x, y}
        // Sorting state
        const [sortKey, setSortKey] = React.useState("patternId");
        const [sortOrder, setSortOrder] = React.useState("asc");

        React.useEffect(() => {
          setIsLoading(true);
          fetch("https://script.google.com/macros/s/AKfycbwB9tUS7pHLR3GYOaik6pYj1_RWAPa4EEwplaV7F9hcv2oHRY0y0DkgdIdo-NgjPf3C/exec?action=getYukiDesign")
            .then(res => res.json())
            .then(json => setData(Array.isArray(json) ? json : []))
            .catch(err => setError("เกิดข้อผิดพลาดในการโหลดข้อมูล: " + err.message))
            .finally(() => setIsLoading(false));
        }, []);

        // Sorting logic
        const sortedData = React.useMemo(() => {
          const arr = [...data];
          arr.sort((a, b) => {
            let aVal = (a[sortKey] || "").toString().toLowerCase();
            let bVal = (b[sortKey] || "").toString().toLowerCase();
            if (aVal < bVal) return sortOrder === "asc" ? -1 : 1;
            if (aVal > bVal) return sortOrder === "asc" ? 1 : -1;
            return 0;
          });
          return arr;
        }, [data, sortKey, sortOrder]);

        // ฟังก์ชัน handle mouse move
        const handleImgMouseMove = (e, url) => {
          setHoverImg({ url, x: e.clientX, y: e.clientY });
        };
        const handleImgMouseLeave = () => setHoverImg(null);

        return (
          <div className="w-full max-5xl mx-auto text-lg flex flex-col items-center justify-center p-4">
            <h1 className="text-3xl font-bold text-gray-800 mb-4">Yuki Show All Data</h1>
            {isLoading ? (
              <div className="flex items-center justify-center py-6">
                <svg className="animate-spin h-6 w-6 text-blue-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
                <span>Loading...</span>
              </div>
            ) : error ? (
              <div className="text-red-600">{error}</div>
            ) : (
              <div className="overflow-x-auto w-full">
                <table className="min-w-full border border-slate-300 bg-white">
                  <thead>
                    <tr className="bg-slate-100 text-base">
                      <th
                        className="px-2 py-2 border cursor-pointer select-none"
                        onClick={() => {
                          if (sortKey === "patternId") setSortOrder(o => (o === "asc" ? "desc" : "asc"));
                          setSortKey("patternId");
                        }}
                      >
                        Pattern ID {sortKey === "patternId" && (sortOrder === "asc" ? "▲" : "▼")}
                      </th>
                      <th
                        className="px-2 py-2 border cursor-pointer select-none"
                        onClick={() => {
                          if (sortKey === "patternName") setSortOrder(o => (o === "asc" ? "desc" : "asc"));
                          setSortKey("patternName");
                        }}
                      >
                        Pattern Name {sortKey === "patternName" && (sortOrder === "asc" ? "▲" : "▼")}
                      </th>
                      <th
                        className="px-2 py-2 border cursor-pointer select-none"
                        onClick={() => {
                          if (sortKey === "productName") setSortOrder(o => (o === "asc" ? "desc" : "asc"));
                          setSortKey("productName");
                        }}
                      >
                        Product Name {sortKey === "productName" && (sortOrder === "asc" ? "▲" : "▼")}
                      </th>
                      <th className="px-2 py-2 border">Product Code</th>
                      <th className="px-2 py-2 border">Colors</th>
                      <th className="px-2 py-2 border">Price</th>
                      <th className="px-2 py-2 border">Product Images</th>
                      <th className="px-2 py-2 border">Product URL</th>
                      <th
                        className="px-2 py-2 border cursor-pointer select-none"
                        onClick={() => {
                          if (sortKey === "groupid") setSortOrder(o => (o === "asc" ? "desc" : "asc"));
                          setSortKey("groupid");
                        }}
                      >
                        Group ID {sortKey === "groupid" && (sortOrder === "asc" ? "▲" : "▼")}
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {sortedData.map((item, idx) => {
                      // Parse arrays if needed
                      let colors = item.colors;
                      let productImages = item.productImages;
                      try { if (typeof colors === 'string') colors = JSON.parse(colors); } catch { colors = []; }
                      try { if (typeof productImages === 'string') productImages = JSON.parse(productImages); } catch { productImages = []; }
                      return (
                        <tr key={idx} className={idx % 2 === 0 ? "bg-white" : "bg-slate-50"}>
                          <td className="px-2 py-1 border">{item.patternId}</td>
                          <td className="px-2 py-1 border">{item.patternName}</td>
                          <td className="px-2 py-1 border">{item.productName}</td>
                          <td className="px-2 py-1 border">{item.productCode || '-'}</td>
                          <td className="px-2 py-1 border">{(Array.isArray(colors) ? colors : []).map((c, i) => (
                            <span key={i} className="inline-block bg-slate-200 rounded px-2 py-1 text-xs text-gray-800 mr-1 mb-1">{c}</span>
                          ))}</td>
                          <td className="px-2 py-1 border">{item.price}</td>
                          <td className="px-2 py-1 border">
                            {(Array.isArray(productImages) ? productImages : []).map((img, i) => (
                              <img
                                key={i}
                                src={img}
                                alt={`img-${i}`}
                                style={{ width: 48, height: 48, objectFit: 'cover', display: 'inline-block', marginRight: 6, borderRadius: 6, border: '1px solid #ccc', cursor: 'pointer' }}
                                onMouseMove={e => handleImgMouseMove(e, img)}
                                onMouseLeave={handleImgMouseLeave}
                                onClick={() => window.open(img, '_blank')}
                                title={`คลิกเพื่อดูรูปใหญ่`}
                              />
                            ))}
                          </td>
                          <td className="px-2 py-1 border">{item.productUrl ? (
                            <a href={item.productUrl.replaceAll('"', '')} target="_blank" rel="noopener noreferrer" className="underline text-blue-600">{item.productUrl}</a>
                          ) : ''}</td>
                          <td className="px-2 py-1 border">{item.groupid}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
                {/* Popup image preview */}
                {hoverImg && (
                  <div
                    style={{
                      position: 'fixed',
                      left: hoverImg.x + 20,
                      top: hoverImg.y + 10,
                      zIndex: 1000,
                      pointerEvents: 'none',
                      background: 'white',
                      border: '1px solid #ccc',
                      borderRadius: '8px',
                      boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
                      padding: 4,
                      maxWidth: 220,
                      maxHeight: 220
                    }}
                  >
                    <img src={hoverImg.url} alt="preview" style={{maxWidth: 200, maxHeight: 200, display: 'block'}} />
                  </div>
                )}
              </div>
            )}
          </div>
        );
      };

      
      const YukiOrderComponent = React.forwardRef((props, ref) => {
        const [searchText, setSearchText] = React.useState("");
        const [products, setProducts] = React.useState([]);
        const [isLoading, setIsLoading] = React.useState(true);
        // popup state
        const [orderPopup, setOrderPopup] = React.useState({ open: false, groupid: null, items: [] });
        const [orderQty, setOrderQty] = React.useState({}); // { color: { productId: qty } }
        // orders state (จำใน localStorage)
        const [orders, setOrders] = React.useState(() => {
          try {
            const saved = localStorage.getItem('yuki_orders');
            return saved ? JSON.parse(saved) : {};
          } catch {
            return {};
          }
        });

        // sync orders -> localStorage
        React.useEffect(() => {
          try {
            localStorage.setItem('yuki_orders', JSON.stringify(orders));
          } catch {}
        }, [orders]);

        React.useEffect(() => {
          setIsLoading(true);
          fetch("https://script.google.com/macros/s/AKfycbwB9tUS7pHLR3GYOaik6pYj1_RWAPa4EEwplaV7F9hcv2oHRY0y0DkgdIdo-NgjPf3C/exec?action=getYukiDesign")
            .then(res => res.json())
            .then(data => setProducts(Array.isArray(data) ? data : []))
            .finally(() => setIsLoading(false));
        }, []);

        // --- Add state for show all toggle ---
        const [showAllProducts, setShowAllProducts] = React.useState(false);
        // กรองข้อมูลตาม searchText
        const filtered = React.useMemo(() => {
          const s = searchText.trim().toLowerCase();
          if (!s && !showAllProducts) return [];
          if (!s && showAllProducts) return products;
          return products.filter(item =>
            (item.patternId || "").toString().toLowerCase().includes(s) ||
            (item.patternName || "").toLowerCase().includes(s) ||
            (item.productName || "").toLowerCase().includes(s) ||
            (item.productCode || "").toLowerCase().includes(s) ||
            (item.groupid || "").toLowerCase().includes(s)
          );
        }, [searchText, products, showAllProducts]);

        // จัดกลุ่มด้วย groupid
        const grouped = React.useMemo(() => {
          const map = {};
          filtered.forEach(item => {
            const gid = item.groupid || "ไม่ระบุ Group";
            if (!map[gid]) map[gid] = [];
            map[gid].push(item);
          });
          return map;
        }, [filtered]);

        // เมื่อกดปุ่ม Confirm
        function handleConfirmOrder() {
          setOrders(prev => ({
            ...prev,
            [orderPopup.groupid]: {
              orderQty: { ...orderQty },
              items: orderPopup.items,
            }
          }));
          setOrderPopup({ open: false, groupid: null, items: [] });
        }

        // เวลากดเลือก groupid ถ้ามี order เดิม ให้โหลดค่ามา
        function openOrderPopup(gid, items) {
          let allColors = [];
          items.forEach(i => {
            let colors = i.colors;
            if (typeof colors === 'string') {
              try { colors = JSON.parse(colors); } catch { colors = []; }
            }
            if (!Array.isArray(colors)) colors = [];
            colors.forEach(c => {
              if (c && !allColors.includes(c)) allColors.push(c);
            });
          });
          let qtyInit = {};
          if (orders[gid]) {
            qtyInit = { ...orders[gid].orderQty };
          } else {
            allColors.forEach(color => {
              qtyInit[color] = {};
              items.forEach(item => {
                qtyInit[color][item.patternId] = 0;
              });
            });
          }
          setOrderPopup({ open: true, groupid: gid, items });
          setOrderQty(qtyInit);
        }

        // ปุ่มล้างคำสั่งซื้อทั้งหมด
        function handleClearOrders() {
          setOrders({});
          try { localStorage.removeItem('yuki_orders'); } catch {}
        }

        function handleQtyChange(color, pid, value) {
          setOrderQty(prev => ({
            ...prev,
            [color]: { ...prev[color], [pid]: value }
          }));
        }

        // --- เพิ่มฟังก์ชัน handleDeleteOrder ---
        function handleDeleteOrder(gid) {
          setOrders(prev => {
            const newOrders = { ...prev };
            delete newOrders[gid];
            try { localStorage.setItem('yuki_orders', JSON.stringify(newOrders)); } catch {}
            return newOrders;
          });
        }

        // --- เพิ่ม state สำหรับควบคุมการแสดงตารางรวม ---
        const [showAllOrdersPopup, setShowAllOrdersPopup] = React.useState(false);
        // เพิ่ม state สำหรับโหมดมินิมอล
        const [minimalMode, setMinimalMode] = React.useState(false);
        // เพิ่ม state สำหรับโหมดมินิมอลขณะ export
        const [minimalPrint, setMinimalPrint] = React.useState(false);

        // --- ฟังก์ชัน export ตารางสรุปไปหน้าต่างใหม่ ---
        React.useImperativeHandle(ref, () => ({
          exportSummaryToNewWindow: (minimalMode = false) => {
            const win = window.open('about:blank', '_blank');
            if (!win) return;
            let html = `<!DOCTYPE html><html><head><title>ตารางสรุปคำสั่งซื้อทั้งหมด</title><meta charset='utf-8'>`;
            html += `<style>@media print { .print-btn { display: none !important; } }</style>`;
            html += `</head><body style='background:#f3f4f6;font-family:Arial,sans-serif;padding:32px;'>`;
            html += `<button class='print-btn' onclick='window.print()' style='display:inline-block;padding:10px 24px;margin-bottom:24px;font-size:1rem;font-weight:bold;background:#2563eb;color:#fff;border:none;border-radius:8px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.08);'>พิมพ์</button>`;
            html += `<div style='font-size:1.5rem;font-weight:bold;color:#2563eb;margin-bottom:24px;'>ตารางสรุปคำสั่งซื้อทั้งหมด</div>`;
            Object.entries(orders).forEach(([gid, order]) => {
              let allColors = [];
              order.items.forEach(i => {
                let colors = i.colors;
                if (typeof colors === 'string') {
                  try { colors = JSON.parse(colors); } catch { colors = []; }
                }
                if (!Array.isArray(colors)) colors = [];
                colors.forEach(c => { if (c && !allColors.includes(c)) allColors.push(c); });
              });
              // filter สีถ้า minimalMode
              let displayColors = allColors;
              if (minimalMode) {
                displayColors = allColors.filter(color => {
                  return order.items.some(item => {
                    const val = Number(order.orderQty?.[color]?.[item.patternId] ?? 0);
                    return !isNaN(val) && val > 0;
                  });
                });
              }
              html += `<div style='margin-bottom:32px;'>`;
              html += `<div style='padding:0;overflow-x:auto;'><table style='width:auto;min-width:600px;max-width:100%;border-collapse:collapse;font-size:1.1rem;border:1px solid #cbd5e1;'>`;
              // thead
              html += `<thead><tr style='background:#f8fafc;'><th style='border:1px solid #cbd5e1;padding:8px;text-align:center;'>สี</th>`;
              order.items.forEach(item => {
                html += `<th style='border:1px solid #cbd5e1;padding:8px;text-align:center;'>`;
                html += `<div style='font-weight:bold;'>${String(item.patternId).replaceAll('"','')}</div>`;
                html += `<hr style='margin:4px 0;border-color:#cbd5e1;' />`;
                html += `<div style='font-size:0.85rem;color:#334155;'>${String(item.productCode).replaceAll('"','')}</div>`;
                html += `<hr style='margin:4px 0;border-color:#cbd5e1;' />`;
                html += `<div style='font-size:0.85rem;color:#64748b;'>${String(item.productName).replaceAll('"','')}</div>`;
                html += `</th>`;
              });
              html += `</tr></thead><tbody>`;
              displayColors.forEach(color => {
                html += `<tr><td style='border:1px solid #cbd5e1;padding:8px;background:#f1f5f9;text-align:center;font-size:0.8rem;'>${color}</td>`;
                order.items.forEach(item => {
                  const val = order.orderQty?.[color]?.[item.patternId] ?? 0;
                  const isZero = Number(val) === 0;
                  html += `<td style='border:1px solid #cbd5e1;padding:8px;text-align:center;${isZero?"color:#9ca3af;background:#f3f4f6;font-weight:normal;":"color:#1e293b;background:#fff;font-weight:bold;"}'>${val}</td>`;
                });
                html += `</tr>`;
              });
              // Spacer
              html += `<tr><td colspan='${order.items.length+1}' style='height:12px'></td></tr>`;
              // รวมจำนวน
              html += `<tr><td style='border:1px solid #cbd5e1;padding:8px;font-weight:bold;background:#fef9c3;text-align:center;'>รวม</td>`;
              order.items.forEach(item => {
                let sum = 0;
                displayColors.forEach(color => {
                  const val = Number(order.orderQty?.[color]?.[item.patternId] ?? 0);
                  if (!isNaN(val)) sum += val;
                });
                const isZero = sum === 0;
                html += `<td style='border:1px solid #cbd5e1;padding:8px;font-weight:bold;background:${isZero?'#f3f4f6':'#fefce8'};text-align:center;color:${isZero?'#9ca3af':'#2563eb'};'>${sum}</td>`;
              });
              html += `</tr>`;
              // ราคา
              html += `<tr><td style='border:1px solid #cbd5e1;padding:8px;background:#f1f5f9;text-align:center;font-weight:bold;'>ราคา</td>`;
              order.items.forEach(item => {
                html += `<td style='border:1px solid #cbd5e1;padding:8px;background:#f1f5f9;text-align:center;color:#2563eb;font-weight:bold;'>${Number(item.price).toLocaleString()}</td>`;
              });
              html += `</tr>`;
              // ราคารวม
              html += `<tr><td style='border:1px solid #cbd5e1;padding:8px;font-weight:bold;background:#dcfce7;text-align:center;'>ราคารวม</td>`;
              order.items.forEach(item => {
                let sum = 0;
                displayColors.forEach(color => {
                  const val = Number(order.orderQty?.[color]?.[item.patternId] ?? 0);
                  if (!isNaN(val)) sum += val;
                });
                const price = Number(item.price) || 0;
                const total = sum * price;
                const isZero = total === 0;
                html += `<td style='border:1px solid #cbd5e1;padding:8px;font-weight:bold;background:${isZero?'#f3f4f6':'#dcfce7'};text-align:center;color:${isZero?'#9ca3af':'#15803d'};'>${total.toLocaleString()}</td>`;
              });
              html += `</tr>`;
              // grand total
              let grandTotal = 0;
              order.items.forEach(item => {
                let sum = 0;
                displayColors.forEach(color => {
                  const val = Number(order.orderQty?.[color]?.[item.patternId] ?? 0);
                  if (!isNaN(val)) sum += val;
                });
                const price = Number(item.price) || 0;
                grandTotal += sum * price;
              });
              html += `<tr><td colspan='${order.items.length+1}' style='border:1px solid #cbd5e1;padding:12px;font-weight:bold;background:#dbeafe;text-align:center;font-size:1.2rem;color:#1d4ed8;'>รวมราคาทั้งหมด: ${grandTotal.toLocaleString()} บาท</td></tr>`;
              html += `</tbody></table></div></div>`;
            });
            html += `</body></html>`;
            win.document.write(html);
            win.document.close();
          }
        }));

        // เพิ่มรับ prop onExportSummaryToNewWindow
        const { onExportSummaryToNewWindow } = props;
        // เพิ่ม state สำหรับ modal เลือกโหมด
        const [showExportModeDialog, setShowExportModeDialog] = React.useState(false);
        const [pendingExportMinimal, setPendingExportMinimal] = React.useState(false);

        // ฟังก์ชันเปิด dialog
        const handleShowExportDialog = () => setShowExportModeDialog(true);
        // ฟังก์ชัน export ตามโหมด
        const handleExportWithMode = (minimal) => {
          setShowExportModeDialog(false);
          if (props.onExportSummaryToNewWindow) {
            props.onExportSummaryToNewWindow(minimal);
          }
        };

        // เพิ่ม state สำหรับ group ที่ขยาย
        const [expandedGroups, setExpandedGroups] = React.useState({});
        // ฟังก์ชัน toggle
        const toggleGroup = gid => setExpandedGroups(prev => ({...prev, [gid]: !prev[gid]}));

        // สำหรับ order สีเหลืองด้านบน
        const [expandedOrderGroups, setExpandedOrderGroups] = React.useState({});
        const toggleOrderGroup = gid => setExpandedOrderGroups(prev => ({...prev, [gid]: !prev[gid]}));
        // สำหรับผลลัพธ์การค้นหา
        const [expandedSearchGroups, setExpandedSearchGroups] = React.useState({});
        const toggleSearchGroup = gid => setExpandedSearchGroups(prev => ({...prev, [gid]: !prev[gid]}));

        return (
          <div className="w-full max-w-2xl mx-auto p-4 flex flex-col items-stretch justify-start" style={{minWidth: '800px', minHeight: '100vh'}}>
            <h1 className="text-2xl font-bold mb-4">Order Products</h1>
            <input
              type="text"
              className="w-full px-3 py-2 border border-gray-300 rounded mb-4"
              placeholder="Search by Pattern ID, Name, Code, or Group ID"
              value={searchText}
              onChange={e => {
                setSearchText(e.target.value);
                if (e.target.value.trim() !== "") setShowAllProducts(false);
              }}
            />
            {/* Show all products button */}
            {filtered.length === 0 && !showAllProducts && products.length > 0 && (
              <div className="mb-4 flex justify-end">
                <button
                  className="px-4 py-2 bg-blue-500 text-white rounded shadow hover:bg-blue-700 transition text-base font-medium"
                  onClick={() => setShowAllProducts(true)}
                >
                  Show all products
                </button>
              </div>
            )}
            {isLoading ? (
              <div>Loading data...</div>
            ) : (
              Object.keys(grouped).length === 0 ? (
                <div className="text-gray-500">No products found</div>
              ) : (
                <div style={{
                  border: '2px solid #e5e7eb',
                  borderRadius: '16px',
                  padding: '12px',
                  marginBottom: '18px',
                  background: '#fafbfc',
                  minHeight: '350px'
                }}>
                  <div style={{maxHeight:'500px',overflowY:'auto'}}>
                    {Object.entries(grouped).map(([gid, items]) => (
                      <div key={gid} className="mb-6 border rounded-lg shadow bg-white">
                        <div className="bg-blue-100 px-4 py-2 font-bold text-blue-700 rounded-t-lg flex items-center justify-between cursor-pointer" onClick={() => toggleSearchGroup(gid)}>
                          <span>Group ID: {String(gid).replaceAll('"','')}</span>
                          <div style={{display:'flex',alignItems:'center',gap:'10px'}}>
                            <button
                              className="ml-2 px-4 py-1 bg-green-600 text-white rounded hover:bg-green-700"
                              onClick={e => { e.stopPropagation(); openOrderPopup(gid, items); }}
                            >
                              Select
                            </button>
                            <span style={{fontSize:'1.2em'}}>{expandedSearchGroups[gid] ? '−' : '+'}</span>
                          </div>
                        </div>
                        {expandedSearchGroups[gid] && (
                          <div className="p-4">
                            <div style={{marginBottom:'8px',fontWeight:'bold',display:'none',color:'#2563eb'}}>Product Codes in this group:</div>
                            <div style={{marginBottom:'16px',display:'none',flexWrap:'wrap',gap:'8px'}}>
                              {items.map(item => (
                                <span key={item.patternId} style={{fontWeight:'bold',background:'#fef9c3',color:'#b45309',padding:'4px 10px',borderRadius:'6px',fontSize:'1rem',border:'1px solid #fde68a'}}>
                                  {String(item.productCode).replaceAll('"','')}
                                </span>
                              ))}
                            </div>
                            <table className="w-full border border-slate-200 text-base mb-2">
                              <thead>
                                <tr className="bg-slate-50">
                                  <th className="border px-2 py-1 font-semibold text-center">Pattern ID</th>
                                  <th className="border px-2 py-1 font-semibold text-center">Product Name</th>
                                  <th className="border px-2 py-1 font-semibold text-center">Product Code</th>
                                  <th className="border px-2 py-1 font-semibold text-center">Price</th>
                                </tr>
                              </thead>
                              <tbody>
                                {items.map((item, idx) => (
                                  <tr key={idx} className="even:bg-slate-50">
                                    <td className="border px-2 py-1 text-center">{String(item.patternId).replaceAll('"', '')}</td>
                                    <td className="border px-2 py-1 text-center">{String(item.productName).replaceAll('"', '')}</td>
                                    <td className="border px-2 py-1 text-center font-bold text-yellow-800">
                                      {item.productUrl ? (
                                        <a href={item.productUrl.replaceAll('"', '')} target="_blank" rel="noopener noreferrer" className="underline text-blue-700 hover:text-blue-900">{String(item.productCode).replaceAll('"', '')}</a>
                                      ) : (
                                        String(item.productCode).replaceAll('"', '')
                                      )}
                                    </td>
                                    <td className="border px-2 py-1 text-center">{Number(item.price).toLocaleString()}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )
            )}
            {/* Divider between product list and order table */}
            <div className="w-full flex items-center my-8">
              <div className="flex-grow border-t border-slate-300"></div>
              <span className="mx-4 text-slate-400 font-semibold text-base">Order</span>
              <div className="flex-grow border-t border-slate-300"></div>
            </div>
            {/* Order table moved below */}
            <div className="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded text-yellow-900 font-medium text-base">
              <span className="font-bold">Order</span> <br/>
              {Object.keys(orders).length === 0 ? (
                <>Order summary will be shown here.</>
              ) : (
                <>
                  <table className="w-full text-sm mt-2 border">
                    <thead>
                      <tr className="bg-yellow-100">
                        <th className="border px-2 py-1"></th>
                        <th className="border px-2 py-1">Group ID</th>
                        <th className="border px-2 py-1">Total Qty</th>
                        <th className="border px-2 py-1">Total Price</th>
                        <th className="border px-2 py-1">Edit</th>
                        <th className="border px-2 py-1">Delete</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.entries(orders).map(([gid, order]) => {
                        // รวมจำนวนและราคารวม
                        let totalQty = 0, totalPrice = 0;
                        order.items.forEach(item => {
                          let sum = 0;
                          Object.values(order.orderQty).forEach(colorRow => {
                            const val = Number(colorRow[item.patternId] ?? 0);
                            if (!isNaN(val)) sum += val;
                          });
                          totalQty += sum;
                          totalPrice += sum * (Number(item.price) || 0);
                        });
                        return (
                          <React.Fragment key={gid}>
                            <tr className="bg-yellow-50">
                              <td className="border px-2 py-1 text-center cursor-pointer" onClick={()=>toggleOrderGroup(gid)} style={{fontSize:'1.2em'}}>
                                {expandedOrderGroups[gid] ? '−' : '+'}
                              </td>
                              <td className="border px-2 py-1 text-center cursor-pointer" onClick={()=>toggleOrderGroup(gid)}>{String(gid).replaceAll('"','')}</td>
                              <td className="border px-2 py-1 text-center cursor-pointer" onClick={()=>toggleOrderGroup(gid)}>{totalQty}</td>
                              <td className="border px-2 py-1 text-center cursor-pointer" onClick={()=>toggleOrderGroup(gid)}>{totalPrice.toLocaleString()}</td>
                              <td className="border px-2 py-1 text-center">
                                <button
                                  className="px-2 py-1 bg-blue-500 text-white rounded text-xs"
                                  onClick={() => openOrderPopup(gid, order.items)}
                                >Edit</button>
                              </td>
                              <td className="border px-2 py-1 text-center">
                                <button
                                  className="px-2 py-1 bg-red-500 text-white rounded text-xs"
                                  onClick={() => handleDeleteOrder(gid)}
                                >Delete</button>
                              </td>
                            </tr>
                            {expandedOrderGroups[gid] && (
                              <tr>
                                <td colSpan={6} className="border px-2 py-2 bg-yellow-50">
                                  {/* รายละเอียดสินค้าใน group นี้ */}
                                  {order.items.map(i => (
                                    <div key={i.patternId} style={{marginBottom:'4px'}}>
                                      <span style={{fontWeight:'bold'}}>{String(i.patternId).replaceAll('"','')}</span>
                                      {' - '}
                                      <span>{String(i.productName).replaceAll('"','')}</span>
                                    </div>
                                  ))}
                                </td>
                              </tr>
                            )}
                          </React.Fragment>
                        );
                      })}
                    </tbody>
                  </table>
                  <div className="flex justify-end mt-2 gap-2">
                    <button
                      className="px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-800"
                      onClick={handleShowExportDialog}
                    >
                      Show all order summary
                    </button>
                    <button
                      className="px-6 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600"
                      onClick={handleClearOrders}
                    >
                      Clear all orders
                    </button>
                  </div>
                </>
              )}
            </div>
            {/* Popup ตารางสั่งซื้อ */}
            {orderPopup.open && (
              <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
                <div
                  className="bg-white rounded-lg shadow-lg p-6 min-w-[400px] max-w-full"
                  style={{
                    maxHeight: '80vh',
                    overflowY: 'auto',
                    maxWidth: '98vw',
                    minWidth: '400px',
                  }}
                >
                  <div className="font-bold text-lg mb-2">สั่งซื้อ Group ID: {orderPopup.groupid}</div>
                  <table className="min-w-full border mb-4">
                    <thead>
                      <tr>
                        <th className="border px-2 py-1 bg-slate-100">สี</th>
                        {orderPopup.items.map(item => (
                          <th key={item.patternId} className="border px-2 py-1 bg-slate-100 text-center">
                            <div className="font-bold">{String(item.patternId).replaceAll('"', '')}</div>
                            <hr className="my-1 border-slate-300" />
                            <div className="text-xs text-gray-700">{String(item.productCode).replaceAll('"', '')}</div>
                            <hr className="my-1 border-slate-300" />
                            <div className="text-xs text-gray-500">{String(item.productName).replaceAll('"', '')}</div>
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {(() => {
                        // รวมสีทั้งหมดจากทุกสินค้าในกลุ่ม (unique, แสดงชื่อสีครบถ้วน)
                        let allColors = [];
                        orderPopup.items.forEach(i => {
                          let colors = i.colors;
                          if (typeof colors === 'string') {
                            try { colors = JSON.parse(colors); } catch { colors = []; }
                          }
                          if (!Array.isArray(colors)) colors = [];
                          colors.forEach(c => {
                            if (c && !allColors.includes(c)) allColors.push(c);
                          });
                        });
                        // สร้างแถวสี
                        const colorRows = allColors.map(color => (
                          <tr key={color}>
                            <td className="border px-2 py-1 bg-slate-50">{color}</td>
                            {orderPopup.items.map(item => (
                              <td key={item.patternId} className="border px-2 py-1">
                                <input
                                  type="number"
                                  min="0"
                                  className="w-full px-1 py-1 border rounded text-center"
                                  value={orderQty[color]?.[item.patternId] ?? 0}
                                  onFocus={e => {
                                    if (e.target.value === '0') {
                                      e.target.value = '';
                                    }
                                  }}
                                  onChange={e => handleQtyChange(color, item.patternId, e.target.value)}
                                />
                              </td>
                            ))}
                          </tr>
                        ));
                        // สร้างแถวรวมจำนวน
                        const sumRow = (
                          <tr>
                            <td className="border px-2 py-1 font-bold bg-yellow-100 text-center">รวม</td>
                            {orderPopup.items.map(item => {
                              let sum = 0;
                              allColors.forEach(color => {
                                const val = Number(orderQty[color]?.[item.patternId] ?? 0);
                                if (!isNaN(val)) sum += val;
                              });
                              return (
                                <td key={item.patternId} className="border px-2 py-1 font-bold bg-yellow-50 text-center">{sum}</td>
                              );
                            })}
                          </tr>
                        );
                        // สร้างแถวแสดงราคาแต่ละ product
                        const priceRowShow = (
                          <tr>
                            <td className="border px-2 py-1 bg-slate-50 text-center font-bold">ราคา</td>
                            {orderPopup.items.map(item => (
                              <td key={item.patternId} className="border px-2 py-1 bg-slate-50 text-center text-blue-700 font-bold">{Number(item.price).toLocaleString()}</td>
                            ))}
                          </tr>
                        );
                        // สร้างแถวราคารวมแต่ละ product
                        const priceRow = (
                          <tr>
                            <td className="border px-2 py-1 font-bold bg-green-100 text-center">ราคารวม</td>
                            {orderPopup.items.map(item => {
                              let sum = 0;
                              allColors.forEach(color => {
                                const val = Number(orderQty[color]?.[item.patternId] ?? 0);
                                if (!isNaN(val)) sum += val;
                              });
                              const price = Number(item.price) || 0;
                              const total = sum * price;
                              return (
                                <td key={item.patternId} className="border px-2 py-1 font-bold bg-green-50 text-center">{total.toLocaleString()}</td>
                              );
                            })}
                          </tr>
                        );
                        // รวมราคาทั้งหมดในตาราง
                        let grandTotal = 0;
                        orderPopup.items.forEach(item => {
                          let sum = 0;
                          allColors.forEach(color => {
                            const val = Number(orderQty[color]?.[item.patternId] ?? 0);
                            if (!isNaN(val)) sum += val;
                          });
                          const price = Number(item.price) || 0;
                          grandTotal += sum * price;
                        });
                        const grandTotalRow = (
                          <tr>
                            <td colSpan={orderPopup.items.length + 1} className="border px-2 py-2 font-bold bg-blue-100 text-center">รวมราคาทั้งหมด: {grandTotal.toLocaleString()} บาท</td>
                          </tr>
                        );
                        return [
                          ...colorRows,
                          <tr key="spacer"><td colSpan={orderPopup.items.length + 1} className="h-3"></td></tr>,
                          sumRow,
                          priceRowShow,
                          priceRow,
                          grandTotalRow
                        ];
                      })()}
                    </tbody>
                  </table>
                  <div className="flex justify-end gap-2">
                    <button
                      className="px-4 py-2 bg-gray-400 text-white rounded"
                      onClick={() => setOrderPopup({ open: false, groupid: null, items: [] })}
                    >
                      ปิด
                    </button>
                    <button
                      className="px-4 py-2 bg-blue-600 text-white rounded"
                      onClick={handleConfirmOrder}
                    >
                      ยืนยันการสั่งซื้อ
                    </button>
                  </div>
                </div>
              </div>
            )}
            {showAllOrdersPopup && Object.keys(orders).length > 0 && (
              <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.3)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:50}}>
                <div style={{background:'#fff',borderRadius:'12px',boxShadow:'0 4px 24px rgba(0,0,0,0.18)',padding:'32px',maxWidth:'1100px',width:'100%',maxHeight:'90vh',overflowY:'auto'}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px',gap:'12px'}}>
                    <div style={{fontSize:'1.25rem',fontWeight:'bold',color:'#2563eb'}}>ตารางสรุปคำสั่งซื้อทั้งหมด</div>
                    <div style={{display:'flex',alignItems:'center',gap:'10px'}}>
                      <button
                        style={{padding:'8px 16px',background:'#2563eb',color:'#fff',borderRadius:'6px',fontWeight:'bold',border:'none',cursor:'pointer'}}
                        onClick={handleShowExportDialog}
                      >เปิดหน้าต่างใหม่</button>
                      <button
                        style={{padding:'8px 16px',background:'#9ca3af',color:'#fff',borderRadius:'6px',fontWeight:'bold',border:'none',cursor:'pointer'}}
                        onClick={() => setShowAllOrdersPopup(false)}
                      >ปิด</button>
                    </div>
                  </div>
                  {/* ออฟชันมินิมอล */}
                  <div style={{marginBottom:'18px',display:'flex',alignItems:'center',gap:'12px'}}>
                    <label style={{fontSize:'1rem',color:'#334155',cursor:'pointer'}}>
                      <input type="checkbox" checked={minimalMode} onChange={e => setMinimalMode(e.target.checked)} style={{marginRight:'8px'}} />
                      แสดงแบบมินิมอล (เฉพาะสีที่มีการสั่งซื้อ)
                    </label>
                  </div>
                  <div style={{maxHeight:'350px',overflowY:'auto',border:'1.5px solid #cbd5e1',borderRadius:'14px',boxShadow:'0 2px 12px rgba(30,64,175,0.08)',padding:'12px',background:'#f8fafc',marginBottom:'16px'}}>
                    {Object.entries(orders).map(([gid, order]) => {
                      // รวมจำนวนและราคารวมแต่ละ product
                      let allColors = [];
                      order.items.forEach(i => {
                        let colors = i.colors;
                        if (typeof colors === 'string') {
                          try { colors = JSON.parse(colors); } catch { colors = []; }
                        }
                        if (!Array.isArray(colors)) colors = [];
                        colors.forEach(c => {
                          if (c && !allColors.includes(c)) allColors.push(c);
                        });
                      });
                      // ถ้า minimalMode: filter สีที่มีการสั่งซื้ออย่างน้อย 1 product
                      let displayColors = allColors;
                      if (minimalMode) {
                        displayColors = allColors.filter(color => {
                          return order.items.some(item => {
                            const val = Number(order.orderQty?.[color]?.[item.patternId] ?? 0);
                            return !isNaN(val) && val > 0;
                          });
                        });
                      }
                      return (
                        <div key={gid} style={{marginBottom:'32px',border:'1px solid #e5e7eb',borderRadius:'12px',boxShadow:'0 2px 8px rgba(0,0,0,0.07)',background:'#fff'}}>
                          <div style={{background:'#dbeafe',padding:'12px 16px',fontWeight:'bold',color:'#2563eb',borderTopLeftRadius:'12px',borderTopRightRadius:'12px',fontSize:'1.1rem'}}>Group ID: {String(gid).replaceAll('"','')}</div>
                          <div style={{padding:'16px',overflowX:'auto'}}>
                            <table style={{width:'100%',borderCollapse:'collapse',fontSize:'1.1rem',border:'1px solid #cbd5e1'}}>
                              <thead>
                                <tr style={{background:'#f8fafc'}}>
                                  <th style={{border:'1px solid #cbd5e1',padding:'8px',textAlign:'center'}}>สี</th>
                                  {order.items.map(item => (
                                    <th key={item.patternId} style={{border:'1px solid #cbd5e1',padding:'8px',textAlign:'center'}}>
                                      <div style={{fontWeight:'bold'}}>{String(item.patternId).replaceAll('"', '')}</div>
                                      <hr style={{margin:'4px 0',borderColor:'#cbd5e1'}} />
                                      <div style={{fontSize:'0.85rem',color:'#334155'}}>{String(item.productCode).replaceAll('"', '')}</div>
                                      <hr style={{margin:'4px 0',borderColor:'#cbd5e1'}} />
                                      <div style={{fontSize:'0.85rem',color:'#64748b'}}>{String(item.productName).replaceAll('"', '')}</div>
                                    </th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody>
                                {displayColors.map(color => (
                                  <tr key={color}>
                                    <td style={{border:'1px solid #cbd5e1',padding:'8px',background:'#f1f5f9',textAlign:'center',fontSize:'0.95rem'}}>{color}</td>
                                    {order.items.map(item => {
                                      const val = order.orderQty?.[color]?.[item.patternId] ?? 0;
                                      const isZero = Number(val) === 0;
                                      return (
                                        <td
                                          key={item.patternId}
                                          style={{
                                            border:'1px solid #cbd5e1',padding:'8px',textAlign:'center',
                                            color: isZero ? '#9ca3af' : '#1e293b',
                                            background: isZero ? '#f3f4f6' : '#fff',
                                            fontWeight: isZero ? 'normal' : 'bold'
                                          }}
                                        >
                                          {val}
                                        </td>
                                      );
                                    })}
                                  </tr>
                                ))}
                                {/* Spacer */}
                                <tr><td colSpan={order.items.length + 1} style={{height:'12px'}}></td></tr>
                                {/* รวมจำนวน */}
                                <tr>
                                  <td style={{border:'1px solid #cbd5e1',padding:'8px',fontWeight:'bold',background:'#fef9c3',textAlign:'center'}}>รวม</td>
                                  {order.items.map(item => {
                                    let sum = 0;
                                    allColors.forEach(color => {
                                      const val = Number(order.orderQty?.[color]?.[item.patternId] ?? 0);
                                      if (!isNaN(val)) sum += val;
                                    });
                                    const isZero = sum === 0;
                                    return (
                                      <td key={item.patternId} style={{border:'1px solid #cbd5e1',padding:'8px',fontWeight:'bold',background:isZero?'#f3f4f6':'#fefce8',textAlign:'center',color:isZero?'#9ca3af':'#2563eb'}}>{sum}</td>
                                    );
                                  })}
                                </tr>
                                {/* ราคา */}
                                <tr>
                                  <td style={{border:'1px solid #cbd5e1',padding:'8px',background:'#f1f5f9',textAlign:'center',fontWeight:'bold'}}>ราคา</td>
                                  {order.items.map(item => (
                                    <td key={item.patternId} style={{border:'1px solid #cbd5e1',padding:'8px',background:'#f1f5f9',textAlign:'center',color:'#2563eb',fontWeight:'bold'}}>{Number(item.price).toLocaleString()}</td>
                                  ))}
                                </tr>
                                {/* ราคารวม */}
                                <tr>
                                  <td style={{border:'1px solid #cbd5e1',padding:'8px',fontWeight:'bold',background:'#dcfce7',textAlign:'center'}}>ราคารวม</td>
                                  {order.items.map(item => {
                                    let sum = 0;
                                    allColors.forEach(color => {
                                      const val = Number(order.orderQty?.[color]?.[item.patternId] ?? 0);
                                      if (!isNaN(val)) sum += val;
                                    });
                                    const price = Number(item.price) || 0;
                                    const total = sum * price;
                                    const isZero = total === 0;
                                    return (
                                      <td key={item.patternId} style={{border:'1px solid #cbd5e1',padding:'8px',fontWeight:'bold',background:isZero?'#f3f4f6':'#dcfce7',textAlign:'center',color:isZero?'#9ca3af':'#15803d'}}>{total.toLocaleString()}</td>
                                    );
                                  })}
                                </tr>
                                {/* grand total */}
                                <tr>
                                  <td colSpan={order.items.length + 1} style={{border:'1px solid #cbd5e1',padding:'12px',fontWeight:'bold',background:'#dbeafe',textAlign:'center',fontSize:'1.2rem',color:'#1d4ed8'}}>
                                    รวมราคาทั้งหมด: {
                                      (() => {
                                        let grandTotal = 0;
                                        order.items.forEach(item => {
                                          let sum = 0;
                                          allColors.forEach(color => {
                                            const val = Number(order.orderQty?.[color]?.[item.patternId] ?? 0);
                                            if (!isNaN(val)) sum += val;
                                          });
                                          const price = Number(item.price) || 0;
                                          grandTotal += sum * price;
                                        });
                                        return grandTotal.toLocaleString();
                                      })()
                                    } บาท
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}
            {showExportModeDialog && (
              <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.25)',zIndex:1000,display:'flex',alignItems:'center',justifyContent:'center'}}>
                <div style={{background:'#fff',padding:'32px',borderRadius:'16px',boxShadow:'0 2px 16px rgba(0,0,0,0.15)',minWidth:'320px',textAlign:'center'}}>
                  <div style={{fontSize:'1.2rem',fontWeight:'bold',marginBottom:'18px'}}>Select display mode</div>
                  <div style={{display:'flex',flexDirection:'column',gap:'16px',marginBottom:'18px'}}>
                    <button style={{padding:'12px',fontSize:'1rem',fontWeight:'bold',background:'#2563eb',color:'#fff',border:'none',borderRadius:'8px',cursor:'pointer'}} onClick={()=>handleExportWithMode(false)}>Normal mode (show all colors)</button>
                    <button style={{padding:'12px',fontSize:'1rem',fontWeight:'bold',background:'#22c55e',color:'#fff',border:'none',borderRadius:'8px',cursor:'pointer'}} onClick={()=>handleExportWithMode(true)}>Minimal mode (only show ordered colors)</button>
                  </div>
                  <button style={{padding:'8px 18px',background:'#9ca3af',color:'#fff',border:'none',borderRadius:'6px',fontWeight:'bold',cursor:'pointer'}} onClick={()=>setShowExportModeDialog(false)}>Cancel</button>
                </div>
              </div>
            )}
          </div>
        );
      });

    </script>


    <!-- App Section -->
    <script type="text/babel">
     

      function App() {
        const [showEdit, setShowEdit] = React.useState(false);
        const [showAll, setShowAll] = React.useState(false);
        const [showOrder, setShowOrder] = React.useState(true);
        const orderRef = React.useRef();
        // ฟังก์ชันสำหรับ export summary ไปหน้าต่างใหม่
        const handleExportSummaryToNewWindow = (minimalMode = false) => {
          if (orderRef.current && orderRef.current.exportSummaryToNewWindow) {
            orderRef.current.exportSummaryToNewWindow(minimalMode);
          }
        };
        // State for menu popup
        const [menuOpen, setMenuOpen] = React.useState(false);
        return (
          <div className="flex flex-col items-center justify-center space-y-6 p-4 relative" style={{minHeight:'100vh'}}>
            {/* Small floating menu button */}
            <button
              style={{position:'fixed',top:24,right:32,zIndex:1001,padding:'8px 12px',borderRadius:'8px',background:'#f3f4f6',boxShadow:'0 2px 8px rgba(0,0,0,0.08)',border:'1px solid #e5e7eb',fontSize:'1.3rem',color:'#334155',cursor:'pointer'}}
              onClick={()=>setMenuOpen(o=>!o)}
              title="Show menu"
            >
              ☰
            </button>
            {/* Floating menu popup */}
            {menuOpen && (
              <div
                style={{position:'fixed',top:60,right:32,zIndex:1002,background:'#fff',border:'1.5px solid #e5e7eb',borderRadius:'12px',boxShadow:'0 4px 24px rgba(0,0,0,0.13)',padding:'18px 20px',display:'flex',flexDirection:'column',gap:'12px',minWidth:'220px'}}
              >
                <button
                  className="px-4 py-2 bg-blue-500 text-white rounded-lg text-base font-medium shadow hover:bg-blue-700 transition"
                  onClick={() => { setShowEdit(e => !e); setShowAll(false); setShowOrder(false); setMenuOpen(false); }}
                >
                  {showEdit ? 'ไปที่หน้าเพิ่มข้อมูล (Add)' : 'ไปที่หน้าแก้ไขข้อมูล (Edit)'}
                </button>
                <button
                  className="px-4 py-2 bg-green-600 text-white rounded-lg text-base font-medium shadow hover:bg-green-700 transition"
                  onClick={() => { setShowAll(s => !s); setShowEdit(false); setShowOrder(false); setMenuOpen(false); }}
                >
                  {showAll ? 'กลับสู่โหมดปกติ' : 'แสดงข้อมูลทั้งหมด'}
                </button>
                <button
                  className="px-4 py-2 bg-yellow-500 text-white rounded-lg text-base font-medium shadow hover:bg-yellow-600 transition"
                  onClick={() => { setShowOrder(true); setShowEdit(false); setShowAll(false); setMenuOpen(false); }}
                >
                  สั่งซื้อสินค้า
                </button>
                {(showEdit || showAll || showOrder) && (
                  <button
                    className="px-4 py-2 bg-gray-400 text-white rounded-lg text-base font-medium shadow hover:bg-gray-500 transition"
                    onClick={() => { setShowEdit(false); setShowAll(false); setShowOrder(false); setMenuOpen(false); }}
                  >
                    กลับสู่เมนูหลัก
                  </button>
                )}
              </div>
            )}
            {showOrder ? (
              <>
                <YukiOrderComponent ref={orderRef} onExportSummaryToNewWindow={handleExportSummaryToNewWindow} />
              </>
            ) : showAll ? <YukiShowAllComponent/> : showEdit ? <YukiEditComponent/> : <YukiAddComponent/>}
          </div>
        );
      }

      // หาส่วนของ DOM ที่จะใช้เป็น Root สำหรับ React Application
      const rootElement = document.getElementById('root');

      // สร้าง React Root และเรนเดอร์ App Component
      // React.StrictMode ช่วยในการตรวจจับปัญหาที่อาจเกิดขึ้นในแอปพลิเคชันของคุณ
      if (rootElement) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
      } else {
        console.error("Root element with ID 'root' not found.");
      }
    </script>
  </body>
</html>
